# CSV Median Calculator

## 1. Описание приложения

Консольное приложение для вычисления медианы цен из файлов формата CSV
с потоковыми данными биржевых торгов.

**Основные возможности:**
- Чтение нескольких CSV-файлов из указанной директории
- Фильтрация файлов по маскам (level, trade и т.д.)
- Расчет медианы с использованием Boost.Accumulators
- Запись результатов только при изменении медианы
- Работа с TOML-конфигурацией
- Детальное логирование используя spdlog


## 2. Требования

### Зависимости
| Библиотека | Назначение | Установка |
|------------|------------|-----------|
| Boost.Program_options | Парсинг аргументов командной строки | `libboost-all-dev` |
| Boost.Accumulators | Инкрементальный расчет медианы | (входит в Boost) |
| spdlog | Логирование | `libspdlog-dev` |
| toml++ | Парсинг TOML-конфигов | `libtomlplusplus-dev` |

### Системные требования
- **ОС**: Linux, macOS, Windows (WSL)
- **Компилятор**: GCC 11+ или Clang 14+ с поддержкой C++23
- **CMake**: версия 3.23 или выше
- **Процессор**: любая архитектура
- **Память**: от 256 МБ


## 3. Сборка проекта

### Быстрая сборка и запуск через Makefile (рекомендуется автором)

```bash
# 1. Клонируем репозиторий
git clone https://github.com/Rushpen/csv_median_calculator.git
cd csv_median_calculator

# 2. Устанавливаем зависимости (Ubuntu/Debian)
make install-deps

# 3. Чисто собираем
make fast

# 4. Быстрая сборка и запуск
make run
```

### Доступные цели Makefile

| Команда | Действие |
|:--------|:---------|
| `make fast` | Собрать проект |
| `make run` | Собрать и запустить |
| `make valgrind` | Проверка утечек памяти |
| `make install-deps` | Установка всех зависимостей(библиотек) |
| `make clean` | Очистка сборки |
| `make rebuild` | Пересборка всего проекта |


### Cборка вручную(по техническому заданию)

```bash
# 1. Проверяем наличие cmake
make install-cmake

# 2. Вводим команду для конфигурации
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

# 3. Команда для сборки
cmake --build build -j$(CORES)
```

#### Что есть что:

- `-S .` — указывает на корневую папку с CMakeLists.txt (текущая директория)
- `-B build` — создаёт папку `build` для всех файлов сборки
- `-DCMAKE_BUILD_TYPE=Release` — режим сборки:
  - `Release` — оптимизированная версия для работы
  - `Debug` — версия с отладочной информацией
  - `RelWithDebInfo` — оптимизированная с отладкой

- `--build build` — собираем проект в папке build
- `j$(CORES)` — параллельная сборка на всех ядрах процессора
- `$(CORES)` автоматически определяет количество ядер


## 4. Запуск приложения

### Быстрая сборка и запуск указаны в разделе #3

### Синтаксис стандартного запуска 

```bash
./build/csv_median_calculator [(--config | --cfg | --conf) <путь_к_конфигу>]
```

### Примеры запуска

```bash

# Стандартный запуск с выборочным конфигурационным файлом
./build/csv_median_calculator -c ./config.toml

# Стандартный запуск без указания конф. файла
./build/csv_median_calculator
```

## 5. Формат конфигурации

### Файл конфигурации в формате TOML:

```toml
[main]
# Путь к директории с входными CSV-файлами (обязательный)
input = "./examples/input"

# Путь для выходных файлов (опционально, по умолчанию ./output)
output = "./results"

# Список масок для фильтрации файлов
# Если не указан - обрабатываются все CSV
filename_mask = ["level", "trade"]
```

### Описание параметров конфигурационного файла

| Команда | Тип данных | По умолчанию | Обязателен | Описание |
|:--------|:---------|:---------|:---------|:---------|
| `input` | string | - | Да | Путь к папке с входными CSV |
| `output` | string | ./output | Нет | Путь к папке для записи результатов |
| `filename_mask` | array<string> | ['level', 'trade'] | Нет | Маски для фильтрации файлов |


## 6. Примеры

### Входные данные (examples/input/btcusdt_level_2024.csv)

```csv
receive_ts;exchange_ts;price;quantity;side;rebuild
1716810808593627;1716810808593592;68485.84016798;11.893234;ask;0
1716810808594627;1716810808594601;68481.88796603;9.467871;ask;0
1716810808595627;1716810808595616;68487.96437344;13.351341;bid;0
1716810808596627;1716810808596556;68480.02709933;13.319324;ask;0
```

### Выходные данные (results/median_results.csv)

```csv
receive_ts;price_median
1716810808593627;0.00000000
1716810808595627;68487.96437344
```

### Пример конфига (config.toml)

```toml
[main]
# Путь к директории с входными CSV-файлами
input = "./examples/input"

# Путь для выходных файлов (опционально)
output = "./output"

# Список масок для фильтрации файлов
filename_mask = ["level", "trade"]
```

### Логи, полученные в ходе работы

```log
[2026-02-19 07:38:22.347] [info] Логирование настроено на уровень TRACE
[2026-02-19 07:38:22.359] [info] Входная директория: ./examples/input
[2026-02-19 07:38:22.359] [info] Выходная директория: ./output
[2026-02-19 07:38:22.359] [info] Маски, полученные из файлов конфига:
[2026-02-19 07:38:22.359] [info]  [level]
[2026-02-19 07:38:22.359] [info]  [trade]
[2026-02-19 07:38:22.364] [info] Найдено файлов: 1
[2026-02-19 07:38:22.364] [info]   - btcusdt_level_2024.csv
[2026-02-19 07:38:22.364] [info] Считывание файла: btcusdt_level_2024.csv
[2026-02-19 07:38:22.365] [info] найдено записей 4
[2026-02-19 07:38:22.366] [info] Прочитано записей: 4
[2026-02-19 07:38:22.368] [info] Изменений медианы(кол.-во): 2
[2026-02-19 07:38:22.369] [info] Статистика:
[2026-02-19 07:38:22.369] [debug]   Первая запись: ts=1716810808593627, price=68485.84016798
[2026-02-19 07:38:22.369] [debug]   Последняя запись: ts=1716810808596627, price=68480.02709933
[2026-02-19 07:38:22.369] [debug] Результат сохранён в: ./output /median_results.csv
```
## 7. Проверка на утечки памяти

### Valgrind

```bash
# Через цель Makefile
make valgrind

# В консоли
valgrind --leak-check=full ./build/csv_median_calculator -c ./config.toml
```

### AddressSanitizer

```bash
# Через цель Makefile
make addressSanitizer

#В консоли
cmake -S . -B build -DENABLE_ASAN=ON -DCMAKE_BUILD_TYPE=Debug
cmake --build build -j$(CORES)
```

## 8. Автоматическая генерация данных

Для удобства тестирования в проекте есть Python-скрипт, который генерирует синтетические биржевые данные.

**[Подробная инструкция по генерации данных](scripts/README.md)**

